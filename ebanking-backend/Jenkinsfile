pipeline {
    agent any

    tools {
        jdk 'JDK17'
        maven 'maven'
    }

    environment {
        SONAR_TOKEN = credentials('Digital Banking backend-token') // token sÃ©curisÃ© pour SonarQube
        IMAGE_NAME = "ebanking-backend:latest"

    }

    stages {

        stage('Checkout') {
            steps {
                echo "ğŸ”¹ Stage: Checkout"
                git branch: 'main',
                    url: 'https://github.com/oussamasebai593/Projet-DigitalBanking-SpringBoot-Angular.git'
            }
        }

        stage('Build Backend') {
            steps {
                echo "ğŸ”¹ Stage: Build Backend"
                dir('ebanking-backend') {
                    sh 'mvn clean compile'
                }
            }
        }

        stage('Run Tests') {
            steps {
                echo "ğŸ”¹ Stage: Run Tests"
                            dir('ebanking-backend') {
                    // Ù†Ø¬Ø¹Ù„ pipeline Ù…Ø§ ÙŠÙØ´Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ùˆ ÙØ´Ù„ test
                    script {
                        def testStatus = sh(script: 'mvn test', returnStatus: true)
                        if (testStatus != 0) {
                            echo "âš ï¸ Some tests failed. Check target/surefire-reports for details."
            }
        }
                            }
            }
        }
                stage('Trivy FS Scan') {
            steps {
                dir('ebanking-backend') {
                    echo "ğŸ”¹ Scan des fichiers backend avec Trivy"
                    sh '''
                    trivy fs --severity CRITICAL,HIGH .
                    '''
                }
            }
        }
        /*    stage('Build Docker Image') {
                steps {
                    dir('ebanking-backend') {
                        echo "ğŸ”¹ Build Docker Image backend"
                        sh 'ls -la target'  // VÃ©rifie que le JAR existe
                        sh "docker build -t ${IMAGE_NAME} ."
                    }
                }
            }

        // ğŸ”¹ Nouvelle Ã©tape: Trivy Image Scan backend
        stage('Trivy Image Scan') {
            steps {
                echo "ğŸ”¹ Scan de l'image Docker backend avec Trivy"
                sh "trivy image --exit-code 1 --severity CRITICAL,HIGH banking-backend:latest"            }
        }*/

                stage('SonarQube Analysis') {
                    steps {
                        echo "ğŸ”¹ Stage: SonarQube Analysis"
                        dir('ebanking-backend') {
                            withSonarQubeEnv('SonarQubeServer') {
                                sh """
                                mvn clean verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
                                  -DskipTests \
                                  -Dsonar.projectKey=Digital-Banking-Backend \
                                  -Dsonar.projectName='Digital Banking Backend' \
                                  -Dsonar.host.url=http://192.168.8.17:9000 \
                                  -Dsonar.token=sqp_4bdac60215dc347f02029c23a208802b2edc449d
                                """
                            }
                        }
                    }
                }

        stage('Quality Gate') {
            steps {
                echo "ğŸ”¹ Stage: Quality Gate"
                timeout(time: 2, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Package') {
            steps {
                echo "ğŸ”¹ Stage: Package"
                dir('ebanking-backend') {
                    sh 'mvn package -DskipTests'
                }
            }
        }
    }

    post {
        always {
            echo 'ğŸ”¹ Backend pipeline terminÃ©'
        }
        success {
            echo 'âœ… Backend build + SonarQube OK'
        }
        failure {
            echo 'âŒ Erreur dans le backend'
        }
    }
}
